---
title: "Tree data"
author: "Trini et al"
date: "`r format(Sys.Date())`"
output: 
  html_document:
    fig_width: 8
    fig_height: 5
    fig_caption: true
    toc: true
    toc_float: true
    self_contained: true
---

This file contains all dependent variable data for analysis

# 0 set up 
```{r include=FALSE}
# load packages
library(tidyverse)
library(sf) 
library(mapview)  
library(tidylog) 
library(dplyr)
library(vegan)
library(codyn)

getwd()
list.files()
list.files('../../BaltimoreStreetTreeProject_Large_Data/')
list.files('../../BaltimoreStreetTreeProject_Large_Data/', recursive = TRUE)
```

# 1 read in street tree data 
```{r include=FALSE}
street_tree <- 
  st_read('../../BaltimoreStreetTreeProject_Large_Data\\bc_forestry_trees_20190319\\bc_forestry_trees_20190319.shp'
, as_tibble = TRUE) %>% 
  filter(LOC_TYPE == "Street") 
```

# 2 combine with BNIA neighborhood boundaries
```{r include=FALSE}
bmore_bnia <- st_read('../../BaltimoreStreetTreeProject_Large_Data\\Community_Statistical_Areas_(CSAs)__Reference_Boundaries/Community_Statistical_Areas_(CSAs)__Reference_Boundaries.shp') |> #BNIA community delineations
  st_make_valid() |>
  st_transform(crs = st_crs(street_tree))

combined <-  
  street_tree %>%
  st_join(bmore_bnia) %>%
  st_drop_geometry()

combined |> 
  write_csv(paste0('../../BaltimoreStreetTreeProject_Large_Data/street_trees_with_neigh_attributes_', Sys.Date(), '.csv'))
```

#3 Read in street tree + neighborhood file
```{r include=FALSE}
combined <-
  read_csv('../../BaltimoreStreetTreeProject_Large_Data/street_trees_with_neigh_attributes_2023-07-27.csv')
```
#4 Clean combined data
```{r}
clean <- combined %>% 
  select(-ID,-OnStr, -OBSERV2, -OBSERV3, -LOC_TYPE, -HARD_SCAPE, -PARCELID, -COLLECTOR, -Inv_Time, -INSPECT_DT, -Inspect_TM, -Notes, -Link, -UniqueID, -UTILITIES, -Neigh) %>% 
  rename(CSA2010 = CSA2020) #doing this because the bnia boundaries only included from 2020 but all demographic data had 2010 boundaries, but they're the same I checked
```
#5 Filter tree data for only present tree species
```{r include=FALSE}
data <- clean %>% 
  mutate(Species=ifelse(SPP=='Acer spp.'|SPP=='Carya spp.'|SPP=='Cornus spp.'|SPP=='Cornus x'|SPP=='Ficus spp.'|SPP=='Fraxinus spp.'|SPP=='Hydrangea spp.'|SPP=='Ilex spp.'|SPP=='Ilex x'|SPP=='Juniperus spp.'|SPP=='Magnolia spp.'|SPP=='Magnolia x'|SPP=='Photinia spp.'|SPP=='Picea spp.'|SPP=='Populus spp.'|SPP=='Quercus spp.'|SPP=='Quercus x'|SPP=='Rhus spp.'|SPP=='Salix spp.'|SPP=='Ulmus spp.', "unknown tree", SPP))%>%
  filter(Species!='Vacant Site'&Species!='Vacant Potential'&Species!='Stump'&Species!='Vacant Site Not Suitable'&Species!='NA'&Species!='unknown shrub'&Species!="Z Add 01"&Species!=" "&Species!="Dead")%>%
  filter(CONDITION!="Dead"&CONDITION!="Stump"&CONDITION!="Sprout")%>% 
  mutate(present=1) %>% #for each tree make a present column with 1
  filter(Species!= "unknown tree")
```

 
#6 Calculate Total Trees Present per CSA
```{r}
NBTotal <-data %>% 
  group_by(CSA2010) %>% 
  summarize(total_trees =sum(present))

#adjust for area and street length

#ratio trees to street length
Total_st <- NBTotal %>% 
  left_join(NBRoads, by = "CSA2010") %>% 
  mutate(total_st = total_trees/sum_road_length_ft)

#ratio trees to area


```
# Calculate Abundance
```{r}
NBabund <-data %>% 
  group_by(CSA2010, Species) %>% 
  summarize(abund=sum(present))
```


#7 Calculate richness and evenness
```{r}
richeven <- community_structure(NBabund, abundance.var="abund", time.var= NULL, replicate.var = "CSA2010")

#richness - adjust for area, street length
```

#8 DBH Class(s/m/L)
```{r}
DBHclass <- data %>%
  mutate(size_class=ifelse(DBH>=0&DBH<=5, "small", ifelse(DBH>5&DBH<20, "medium", ifelse(DBH>=20, "large", 999)))) %>% 
  group_by(CSA2010, size_class) %>% 
  summarize(n=length(DBH)) %>% 
  pivot_wider(names_from = size_class, values_from = n, values_fill = 0)

```

#9 Average DBH by neighborhood
```{r}
AvgDBH <- data %>% 
  select(CSA2010,DBH)%>% 
  group_by(CSA2010) %>% 
  summarise(AvgDBH = mean(DBH), .groups = 'drop')
```


#10 Calculate CV of all DBH measurements by neighborhood
```{r}
CvDBH<- data %>% 
  group_by(CSA2010) %>% 
  summarise(mean = mean(DBH), 
            sd = sd(DBH)) %>% 
  mutate(cv = sd/mean)
```

#11 Abundance, Richness, evenness for small trees
```{r}
NBabundSM <-data %>% 
  filter(DBH>=0&DBH<=5) %>% 
  group_by(CSA2010, Species) %>% 
  summarize(abund=sum(present)) 


#calculate richness and eveness for small trees
richevenSM <- community_structure(NBabundSM, abundance.var="abund", time.var= NULL, replicate.var = "CSA2010")

#adjust for area and street length

```


#12 Medium trees
```{r}
NBabundM <-data %>% 
  filter(DBH>5&DBH<20) %>% 
  group_by(CSA2010, Species) %>% 
  summarize(abund=sum(present)) 


#calculate richness and eveness for medium trees
richevenM <- community_structure(NBabundM, abundance.var="abund", time.var= NULL, replicate.var = "CSA2010")

```


#13 Large trees
```{r}
NBabundL <-data %>% 
  filter(DBH<=20) %>% 
  group_by(CSA2010, Species) %>% 
  summarize(abund=sum(present)) 


#calculate richness and eveness for medium trees
richevenL <- community_structure(NBabundL, abundance.var="abund", time.var= NULL, replicate.var = "CSA2010")
```


#14 % native or introduced 
```{r}

species <- data %>% 
  select(Species) %>% 
  unique() 

n_vs_i <- #I'll come up with a more descriptive name, this is the file specifying whether a species is native or introduced
  read.csv("../../BaltimoreStreetTreeProject_Large_Data/year-plot-species-abundance-addnotree.csv") %>% 
  select(Native, Commonname, Species)

#  mutate(Native = if statement? (Species == ), 'no') or maybe casewhen()?
#^ native yes/no?
```


#15 Combine all dependent variables
```{r}
 DepVar <- NBTotal %>% 
  left_join(NBabund, by = "CSA2010") %>% 
  left_join(richeven, by = "CSA2010") %>%
  left_join(DBHclass, by = "CSA2010") %>%
  left_join(AvgDBH, by = "CSA2010") %>% 
  left_join(CvDBH, by = "CSA2010") %>% 
  left_join(NBabundSM, by = "CSA2010") %>% 
  left_join(NBabundM, by = "CSA2010") %>% 
  left_join(NBabundL, by = "CSA2010") %>% 
  left_join(richevenSM, by = "CSA2010") %>% 
  left_join(NBabundM, by = "CSA2010") %>% 
  left_join(NBabundL, by = "CSA2010")
  
```




